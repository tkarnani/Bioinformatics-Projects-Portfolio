---
title: "Unsupervised Machine Learning Project"
author: "Tusha Karnani"
format: pdf
toc: true
---

## Background

The goal of this mini-project is to explore a complete analysis using  unsupervised learning techniques. I look at combining PCA as a pre-processing step to clustering using data that consists of measurements of cell nuclei of human breast masses. This also expands on my experience with RNA-Seq analysis.

The data itself comes from the Wisconsin Breast Cancer Diagnostic Data Set first reported by K. P. Benne and O. L. Mangasarian: “Robust Linear Programming Discrimination of Two Linearly Inseparable Sets”.

Values in this data set describe characteristics of the cell nuclei present in digitized images of a fine needle aspiration (FNA) of a breast mass.


## Data import

Data was downloaded as a csv file.

```{r}
wisc.df <- read.csv("WisconsinCancer.csv", row.names=1)
head(wisc.df)
```

Removing the first "diagnosis" column since I want to use unsupervised methods to classify this data.

```{r}
wisc.data <- wisc.df[,-1]
head(wisc.data)
```

Saving the diagnosis column so we can refer to it later.

```{r}
diagnosis <- wisc.df[,1]
```

> How many observations are in this dataset?

```{r}
nrow(wisc.df)
```


> How many of the observations have a malignant diagnosis?

```{r}
sum(diagnosis == "M")
```

> How many variables/features in the data are suffixed with _mean?

```{r}
length(grep("_mean", colnames(wisc.data))) # returns column numbers of the column names with "_mean"
grep("_mean", colnames(wisc.data), value=TRUE) # returns column names with "_mean"
```

## Principal Component Analysis

Need to do EDA to check if the data is scaled.

```{r}
colMeans(wisc.data)
```

```{r}
apply(wisc.data,2,sd)
```

### Performing PCA

Note: The `prcomp()` function has a `scale=FALSE` default. We nearly always want to set this as `TRUE` since we don't want our analysis to be dominated by columns/variables in our data set that have high standard deviation and mean when compared to others simply because the measurements are on different units/scales.

```{r}
# scaling makes the sd=1
wisc.pr <- prcomp(wisc.data, scale=TRUE)
summary(wisc.pr)
```

About 44.27% of the original variance is captured by PC1.

> How many principal components (PCs) are required to describe at least 70% of the original variance in the data?

3

> How many principal components (PCs) are required to describe at least 90% of the original variance in the data?

7

### Visualizing PCA results

```{r}
library(ggplot2)

ggplot(wisc.pr$x) +
  aes(PC1, PC2, col=diagnosis) +
  geom_point()
```

```{r}
ggplot(wisc.pr$x) +
  aes(PC1, PC3, col=diagnosis) +
  geom_point()
```

Since PC2 explains more variance than PC3, the groups are more separated in the first plot

```{r}
pr.var <- wisc.pr$sdev^2
head(pr.var)
```

```{r}
# Variance explained by each principal component: pve
pve <- wisc.pr$sdev^2 / sum(wisc.pr$sdev^2)

# Plot variance explained for each principal component
plot(pve, xlab = "Principal Component", 
     ylab = "Proportion of Variance Explained", 
     ylim = c(0, 1), type = "o")
```

```{r}
# Alternative scree plot of the same data, note data driven y-axis
barplot(pve, ylab = "Precent of Variance Explained",
     names.arg=paste0("PC",1:length(pve)), las=2, axes = FALSE)
axis(2, at=pve, labels=round(pve,2)*100 )
```

```{r}
wisc.pr$rotation[,1]
```

## Hierarchical clustering

```{r}
# Scale the wisc.data data using the "scale()" function
data.scaled <- scale(wisc.data)

data.dist <- dist(data.scaled)

wisc.hclust <- hclust(data.dist, method="complete")
wisc.hclust
```

```{r}
plot(wisc.hclust)
abline(h=19, col="red", lty=2)
```

For 4 clusters, we need to cut it off at h=~19.

```{r}
wisc.hclust.clusters <- cutree(wisc.hclust, h=19)
table(wisc.hclust.clusters, diagnosis)
```

For the above, Group 1 seems to be malignant patients and Group 3 seems to be benign patients.

I noted that creating either 4 or 8 groups seemed to be the best choices for cluster vs diagnoses matches.

```{r}
wisc.hclust.sample <- hclust(data.dist, method="complete")
plot(wisc.hclust.sample)
wisc.hclust.clusters.sample <- cutree(wisc.hclust.sample, k=8)
table(wisc.hclust.clusters.sample, diagnosis)
```

```{r}
wisc.hclust.sample1 <- hclust(data.dist, method="single")
plot(wisc.hclust.sample1)
wisc.hclust.clusters.sample1 <- cutree(wisc.hclust.sample1, k=4)
table(wisc.hclust.clusters.sample1, diagnosis)
```

```{r}
wisc.hclust.sample2 <- hclust(data.dist, method="complete")
plot(wisc.hclust.sample2)
wisc.hclust.clusters.sample2 <- cutree(wisc.hclust.sample2, k=4)
table(wisc.hclust.clusters.sample2, diagnosis)
```

```{r}
wisc.hclust.sample3 <- hclust(data.dist, method="average")
plot(wisc.hclust.sample3)
wisc.hclust.clusters.sample3 <- cutree(wisc.hclust.sample3, k=4)
table(wisc.hclust.clusters.sample3, diagnosis)
```

```{r}
wisc.hclust.sample4 <- hclust(data.dist, method="ward.D2")
plot(wisc.hclust.sample4)
wisc.hclust.clusters.sample4 <- cutree(wisc.hclust.sample4, k=4)
table(wisc.hclust.clusters.sample4, diagnosis)
```


## Combining methods

### Clustering based on PCA results

Clustering the original data was not very productive. The PCA results looked promising. So clustering in PC space will help.

```{r}
# take the first 3 PCs 
dist.pc <- dist(wisc.pr$x[,1:3])
wisc.pr.hclust <- hclust(dist.pc, method="ward.D2")
```

```{r}
plot(wisc.pr.hclust)
abline(h=70, col="red")
```

To get our clustering membership vector, we cut the tree.

```{r}
grps <- cutree(wisc.pr.hclust, h=70)
table(grps)
```

How does this clustering compare to the actual diagnosis?

```{r}
table(grps, diagnosis)
```

## Specificity and Sensitivity

Sensitivity refers to a test’s ability to correctly detect ill patients who do have the condition. In our example here the sensitivity is the total number of samples in the cluster identified as predominantly malignant (cancerous) divided by the total number of known malignant samples. In other words: TP/(TP+FN).

Specificity relates to a test’s ability to correctly reject healthy patients without a condition. In our example specificity is the proportion of benign (not cancerous) samples in the cluster identified as predominantly benign that are known to be benign. In other words: TN/(TN+FN).


## Predictions

```{r}
url <- "new_samples.csv"
new <- read.csv(url)
npc <- predict(wisc.pr, newdata=new)
npc
```

```{r}
g <- as.factor(grps)
levels(g)
g <- relevel(g,2)
levels(g)
```


```{r}
plot(wisc.pr$x[,1:2], col=g)
points(npc[,1], npc[,2], col="blue", pch=16, cex=3)
text(npc[,1], npc[,2], c(1,2), col="white")
```